@page "/settings"

@using TimeTracker.Web.Blazor.Server.Components.Elements
@using TimeTracker.Web.Blazor.Server.Modals
@using TimeTracker.Web.Blazor.Server.Models
@using TimerTracker.BE.Web.BusinessLogic.Models.DTOs

@inherits BasePage

<style>
    .container {
        display: flex;
        justify-content: space-between;
    }

    .column {
        width: 48%; /* Nastaví šířku sloupců na 48%, aby zůstalo trochu místa mezi nimi */
    }
</style>

<h3>Settings</h3>

<div class="container">
    <div id="project" class="column">
        <h4>Projects</h4>
        <div id="menuButtonsProject">
            <MButton OnClick="showModalAddProject">Add</MButton>
            <MButton OnClick="showModalEditProject">Edit</MButton>
            <MButton OnClick="showModalDeleteProject">Delete</MButton>
        </div>
        <div>
            <MTable TRow="ProjectBaseDto" Rows="_projects" Columns="_projectColumns" OnRowSelected="OnProjectRowSelected" />
        </div>
    </div>
    <div id="submodule" class="column">
        <h4>SubModules</h4>
        <div id="submoduleButtonsProject">
            <MButton OnClick="showModalAddSubmodule">Add</MButton>
            <MButton OnClick="showModalEditSubmodule">Edit</MButton>
            <MButton OnClick="showModalDeleteSubmodule">Delete</MButton>
        </div>
        <div>
            <MTable TRow="SubModuleBaseDto" Rows="_subModules" Columns="_subModuleColumns" OnRowSelected="OnSubModuleRowSelected" />
        </div>
    </div>
</div>

<AddOrEditProjectModal Title="Add project"
                       @bind-Visible="IsOpenAddProjectModal"
                       OnModalClosed="onCloseModalAddPrjectChanged">
</AddOrEditProjectModal>

<AddOrEditSubModuletModal Title="Add submodule"
                          @bind-Visible="IsOpenAddSubModuleModal">
</AddOrEditSubModuletModal>


@code {
    private List<ProjectBaseDto> _projects;
    private List<TableColumnDefinition<ProjectBaseDto>>? _projectColumns;

    private List<SubModuleBaseDto> _subModules;
    private List<TableColumnDefinition<SubModuleBaseDto>>? _subModuleColumns;

    public bool IsOpenAddProjectModal { get; set; } = false;
    public bool IsOpenAddSubModuleModal { get; set; } = false;

    protected async override Task OnInitializedAsync()
    {

        _projectColumns = CreateTableColumnDefinition_Project();
        _subModuleColumns = CreateTableColumnDefinition_SubModuleBaseDto();

        loadProjectList();
        loadSubModuleList();

        await base.OnInitializedAsync();
    }

    private async void loadProjectList()
    {
        var projects = await _httpClient.GetFromJsonAsync<List<ProjectBaseDto>>("/api/v1/projects");
        if (projects != null)
            _projects = projects;

        base.StateHasChanged();
    }

    private async void loadSubModuleList()
    {
        var subModules = await _httpClient.GetFromJsonAsync<List<SubModuleBaseDto>>("/api/v1/projects/submodules");
        if (subModules != null)
            _subModules = subModules;

        base.StateHasChanged();
    }

    private void showModalAddProject()
    {
        IsOpenAddProjectModal = true;
    }

    private void onCloseModalAddPrjectChanged()
    {
        loadProjectList();
    }

    private void showModalEditProject()
    {
        // _modalService.ShowModal<EditProjectModal>("Edit Project", 400, 200);
    }

    private void showModalDeleteProject()
    {
        // _modalService.ShowModal<DeleteProjectModal>("Delete Project", 400, 200);
    }

    private void showModalAddSubmodule()
    {
        IsOpenAddSubModuleModal = true;
    }

    private void showModalEditSubmodule()
    {
        // _modalService.ShowModal<EditProjectModal>("Edit Project", 400, 200);
    }

    private void showModalDeleteSubmodule()
    {
        // _modalService.ShowModal<DeleteProjectModal>("Delete Project", 400, 200);
    }

    public static List<TableColumnDefinition<ProjectBaseDto>> CreateTableColumnDefinition_Project()
    {
        return new List<TableColumnDefinition<ProjectBaseDto>>
                {
                    new TableColumnDefinition<ProjectBaseDto>
                    {
                        Header = "Name",
                        Key = nameof(ProjectBaseDto.Name),
                        Width=150,
                        eTypeColumn=eTypeColumn.Text
                    },
                };
    }

    public static List<TableColumnDefinition<SubModuleBaseDto>> CreateTableColumnDefinition_SubModuleBaseDto()
    {
        return new List<TableColumnDefinition<SubModuleBaseDto>>
                {
                    new TableColumnDefinition<SubModuleBaseDto>
                    {
                        Header = "Name",
                        Key = nameof(ProjectBaseDto.Name),
                        Width=150,
                        eTypeColumn=eTypeColumn.Text
                    },
                };
    }

    private ProjectBaseDto? selectedProject = null;
    private SubModuleBaseDto? selectedSubModule = null;
        
    // Handle row selection for projects
    private void OnProjectRowSelected(ProjectBaseDto selectedRow)
    {
        selectedProject = selectedRow;
    }

    // Handle row selection for submodules
    private void OnSubModuleRowSelected(SubModuleBaseDto selectedRow)
    {
        selectedSubModule = selectedRow;
    }
}
