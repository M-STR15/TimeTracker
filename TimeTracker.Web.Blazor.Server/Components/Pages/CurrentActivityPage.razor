@page "/current-activity"
@using AutoMapper
@using TimeTracker.BE.DB.Models.Enums
@using TimeTracker.BE.Web.BusinessLogic.Models.DTOs
@using TimeTracker.Web.Blazor.Server.Components.Elements
@using TimeTracker.Web.Blazor.Server.Helpers
@using TimeTracker.Web.Blazor.Server.Modals
@using TimeTracker.Web.Blazor.Server.Models

@inherits BasePage
@inject IMapper _mapper

<style>
    table {
        border-collapse: collapse;
        width: auto;
    }

    td, th {
        border: 1px solid black;
        padding: 8px;
        text-align: center;
    }

    .col-1 {
        width: 30%;
    }

    .col-2 {
        width: 40%;
    }

    .col-3 {
        width: 30%;
    }

    table {
        table-layout: fixed;
        width: 450px;
    }
</style>

<div>
    <MButton Text="Change" OnClick="onOpenAddActvityModal" Style="width:150px"></MButton>
    <MButton Text="Pause" Style="width:150px"></MButton>
    <MButton Text="End of shift" Style="width:150px"></MButton>
</div>

@if (_lastRecordActivity != null)
{
    <table>
        <tr>
            <th colspan="3">Last setting</th>
        </tr>
        <tr>
            <th class="col-1">Date shift</th>
            <th class="col-2">Activity</th>
            <th class="col-3">Time</th>
        </tr>
        <tr>
            <td class="col-1"></td>
            <td class="col-2">@(_lastRecordActivity?.ActivityName ?? "")</td>
            <td class="col-3">@(_lastRecordActivity?.Time ?? "")</td>
        </tr>
        <tr>
            <th class="col-1">Project</th>
            <th class="col-2">Submodule</th>
            <th class="col-3">Act. time</th>
        </tr>
        <tr>
            <td class="col-1">@(_lastRecordActivity?.ProjectName ?? "")</td>
            <td class="col-2">@(_lastRecordActivity?.SubModuleName ?? "")</td>
            <td class="col-3">@(_lastRecordActivity?.StartDateTime.ToString("dd.MM.yyyy HH:mm:ss") ?? "")</td>
        </tr>
    </table>

    <table>
        <tr>
            <th colspan="3">Total time</th>
        </tr>
        <tr>
            <th class="col-1"></th>
            <th class="col-2">Today</th>
            <th class="col-3">In shift</th>
        </tr>
        <tr>
            <th class="col-1">Work</th>
            <td class="col-2"></td>
            <td class="col-3"></td>
        </tr>
        <tr>
            <th class="col-1">Pause</th>
            <td class="col-2"></td>
            <td class="col-3"></td>
        </tr>
        <tr>
            <th class="col-1">Total</th>
            <td class="col-2"></td>
            <td class="col-3"></td>
        </tr>
    </table>
}

<AddActivityModal Title="Change activity"
                  @bind-Visible="_isOpenAddActivityModal"
                  OnModalClosed="onAfterCloseModalAddActivity_Changed" />
@code {
    private bool _isOpenAddActivityModal;
    private void onOpenAddActvityModal() => _isOpenAddActivityModal = true;
    private RecordListViewModel? _lastRecordActivity;
    private bool isRunning = true;

    protected async override Task OnInitializedAsync()
    {
        try
        {
            var urlApi = "/api/v1/last-record-activity";
            var lastRecordActivity = await _httpClient.GetFromJsonAsync<RecordActivityDetailDto>(urlApi);
            _lastRecordActivity = _mapper.Map<RecordListViewModel>(lastRecordActivity);
            await base.OnInitializedAsync();
        }
        catch (Exception)
        {

        }
        try
        {
            var timer = new PeriodicTimer(TimeSpan.FromSeconds(1)); // každé 2 sekundy
            while (await timer.WaitForNextTickAsync() && isRunning)
            {

                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {

        }

    }

    //   private RecordActivity? _lastRecordActivity
    // {
    // 	get => _lra;
    // 	set
    // 	{
    // 		_lra = value;
    // 	}
    // }

    private void onAfterCloseModalAddActivity_Changed()
    {


    }

    public void Dispose()
    {
        isRunning = false;
    }

}
