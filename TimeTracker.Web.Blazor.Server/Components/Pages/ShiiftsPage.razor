@page "/shifts"
@using System.Globalization
@using TimeTracker.BE.Web.BusinessLogic.Models.DTOs
@using TimeTracker.Web.Blazor.Server.Helpers
@using TimeTracker.Web.Blazor.Server.Models

@inherits BasePage

<style>
    .container2 {
        display: flex;
        justify-content: flex-start;
    }

</style>

<h3>ShiftsPage</h3>
<div style="display: flex; flex-direction: column; gap: 1rem;">
    <div>
        <label>Month:</label>
        <MCombobox Items="_monthAndYears" @bind-SelectedItem="SelectMonthAndYear" ItemText="formatMonthAndYear" />
    </div>
    <div class="container2">
        <label>Set type:</label>
        <div>
            @if (_typeShifts != null)
            {
                <MRadioGroup TItem="TypeShiftBaseDto" ListItems="_typeShifts" @bind-SelectItem="_selectTypeShift"></MRadioGroup>
            }
        </div>
    </div>
</div>
<div>

    @if (_days == null)
    {
        <MLoader />
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    @if (_daysName != null)
                    {
                        @foreach (var dayName in _daysName)
                        {
                            <th>@dayName</th>
                        }
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var week in getWeeks(_days))
                {
                    <tr>
                        @foreach (var day in week)
                        {
                            if (day != null)
                            {
                                <td>
                                    <MButton Text="@day.StartDate.ToString("dd")" Style="@getColor(day)" OnClick="()=>setDayTypeShift(day)" />
                                </td>
                            }
                            else
                            {
                                <td></td>
                            }
                        }
                    </tr>
                }
            </tbody>
        </table>
    }
</div>
<MButton Text="Save" OnClick="onSave_Click" Style="width: 100%;"></MButton>
@code {
    private List<DateTime> _monthAndYears = new();
    private DateTime _selectMonthAndYear;
    public DateTime SelectMonthAndYear
    {
        get => _selectMonthAndYear;
        set
        {
            if (_selectMonthAndYear != value)
            {
                _selectMonthAndYear = value;
                generateDays(_selectMonthAndYear);
            }
        }
    }
    private List<ShiftViewModel> _days = new();
    private string[] _daysName = new[] { "Po", "Út", "St", "Čt", "Pá", "So", "Ne" };
    private List<TypeShiftBaseDto>? _typeShifts = new();
    private TypeShiftBaseDto? _selectTypeShift { get; set; }
    private string formatMonthAndYear(DateTime item) => item.ToString("MM.yyyy");

    protected async override Task OnInitializedAsync()
    {
        try
        {
            _monthAndYears = GeneratorDatesHelper.GetMontData().ToList();

            if (_httpClient != null)
            {
                _typeShifts = await _httpClient.GetFromJsonAsync<List<TypeShiftBaseDto>>("/api/v1/shifts/types");

                if (_typeShifts == null)
                    return;

                _selectTypeShift = _typeShifts.FirstOrDefault();
                SelectMonthAndYear = _monthAndYears.FirstOrDefault();
            }

            this.StateHasChanged();
        }
        catch (Exception ex)
        {
            _eventLogService?.LogError(Guid.Parse("b4af9873-6259-4a02-aef9-69c3a0ca38a3"), ex);
        }
    }

    // private void onChangItemDateChanged(ChangeEventArgs e)
    // {
    //     var item = e.Value as MonthAndYearItem;
    //     if (item != null && !EqualityComparer<MonthAndYearItem>.Default.Equals(_selectMonthAndYear, item))
    //     {
    //         _selectMonthAndYear = item;
    //         generateDays(item);
    //     }
    // }

    private async void generateDays(DateTime item)
    {
        try
        {

            if (_httpClient == null)
                return;

            // "api/v1/shifts"
            var planShiftsInDB = await _httpClient.GetFromJsonAsync<List<ShiftBaseDto>>("/api/v1/shifts");
            // await _shiftProvider.GetShiftsAsync(firstDate, lastDate);


            if (planShiftsInDB == null || _typeShifts == null)
                return;

            _days.Clear();
            _days = GeneratorDatesHelper.GetDaysInMonth(item, planShiftsInDB, _typeShifts).ToList();


            this.StateHasChanged();
        }
        catch (Exception ex)
        {
            _eventLogService?.LogError(Guid.Parse("b7b5fd7d-ce70-4fb4-a9e1-4c9b752c5895"), ex);
        }
    }

    private void setDayTypeShift(ShiftViewModel day)
    {
        if (day.TypeShift == null)
            day.TypeShift = _selectTypeShift;
        else
            day.TypeShift = null;

        this.StateHasChanged();
    }

    private List<List<ShiftViewModel?>> getWeeks(List<ShiftViewModel> days)
    {
        var weeks = new List<List<ShiftViewModel?>>();
        if (days.Count == 0)
            return weeks;

        var firstDate = days.First().StartDate;
        int dayOfWeek = ((int)firstDate.DayOfWeek + 6) % 7; // 0 = Po, ..., 6 = Ne

        var currentWeek = new List<ShiftViewModel?>();
        // Add empty cells for days before the first day
        for (int i = 0; i < dayOfWeek; i++)
        {
            currentWeek.Add(null);
        }

        foreach (var day in days)
        {
            currentWeek.Add(day);
            if (currentWeek.Count == 7)
            {
                weeks.Add(currentWeek);
                currentWeek = new List<ShiftViewModel?>();
            }
        }

        // Add remaining days
        if (currentWeek.Count > 0)
        {
            while (currentWeek.Count < 7)
            {
                currentWeek.Add(null);
            }
            weeks.Add(currentWeek);
        }

        return weeks;
    }

    private string getColor(ShiftViewModel day)
    {
        var color = day?.TypeShift?.Color;
        return color != null ? $"background-color:{color}" : "";
    }

    private async void onSave_Click()
    {
        try
        {
            var shiftsDto = new List<ShiftBaseDto>();
            var days = _days.Where(x => x.TypeShift != null).ToList();

            if (days == null)
                return;

            foreach (var item in days)
            {
                var shift = new ShiftBaseDto(item.GuidId, item.StartDate, item.TypeShift.Id);
                shiftsDto.Add(shift);
            }


            if (_httpClient == null)
                return;

            var result = await _httpClient.PutAsJsonAsync<List<ShiftBaseDto>>("/api/v1/shifts", shiftsDto);
        }
        catch (Exception ex)
        {
            _eventLogService?.LogError(Guid.Parse("0653d232-5285-414b-8ed9-98dad4958349"), ex);
        }
    }
}
